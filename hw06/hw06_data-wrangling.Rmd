---
title: 'STAT547 Homework 06: Data wrangling wrap up'
output: github_document
---

### Load packages

Load necessary packages.

```{r message=FALSE}
library(tidyverse)
library(stringr)
library(knitr)
library(gapminder)
library(testthat)
library(ggplot2)
library(MASS)
```


## 2. Writing functions

Write a function to compute the robust regression of life expectancy on year with the Gapminder data. `MASS::rlm()` will be used.

#### Practice with some data

Extract data for one country to interactively work with the code.

```{r}
p_country <- "Canada"
p_dat <- gapminder %>%
    filter(country == p_country)

kable(p_dat)
```

Plot the data to see what it looks like!

```{r}
p <- ggplot(p_dat, aes(x = year, y = lifeExp))
p + geom_point() + geom_smooth(method = "rlm", se = FALSE) + theme_bw()
```


#### Practice with working code

Fit the robust regression.

```{r}
p_fit <- rlm(lifeExp ~ year, p_dat)
coef(p_fit)
```

Hmm... it doesn't seem quite right that life expectancy was about -358. Let's make this more appropriate and set life expectancy to the earliest year in Gapminder (1952).

```{r}
p_fit <- rlm(lifeExp ~ I(year - 1952), p_dat)
coef(p_fit)
```

#### Turn the working code into a function!

```{r}
robust_fit <- function(dat, offset = 1952) {
  the_fit <- rlm(lifeExp ~ I(year - offset), dat)
  setNames(coef(the_fit), c("intercept", "slope"))
}
robust_fit(p_dat)
```

Hooray, we get the same result as above!

#### Test the function on other data

Let's look at the robust regression of life expectancy on year in Algeria.

```{r}
p_country2 <- "Algeria"
p_dat2 <- gapminder %>%
    filter(country == p_country2)

kable(p_dat2)
```

Plot the data!

```{r}
p2 <- ggplot(p_dat2, aes(x = year, y = lifeExp))
p2 + geom_point() + geom_smooth(method = "rlm", se = FALSE) + theme_bw()
```

Use our function!

```{r}
robust_fit(p_dat2)
```

It works! This function calculates the robust regression of life expectancy on year (with the earliest year of 1952).






















